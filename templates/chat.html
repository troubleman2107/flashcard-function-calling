<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vocabulary Chat Assistant</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/marked.min.js"></script>

    <style>
      body {
        background-color: #f4f6f8;
        padding: 0;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }

      .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin-top: 60px;
        background: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding-bottom: 20px;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        border-radius: 0;
      }

      .mode-selector {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .mode-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        background: white;
        color: #6c757d;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 140px;
        justify-content: center;
      }

      .mode-btn:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .mode-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .mode-btn .mode-icon {
        font-size: 1.2rem;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        max-height: calc(100vh - 280px);
      }

      .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
      }

      .message.user .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
      }

      .message.bot .message-bubble {
        background: #f1f3f5;
        color: #333;
        border: 1px solid #e9ecef;
      }

      /* Markdown styling within message bubbles */
      .message-bubble h1,
      .message-bubble h2,
      .message-bubble h3,
      .message-bubble h4,
      .message-bubble h5,
      .message-bubble h6 {
        margin: 0.5rem 0;
        color: inherit;
      }

      .message-bubble p {
        margin: 0.5rem 0;
        line-height: 1.5;
      }

      .message-bubble strong,
      .message-bubble b {
        font-weight: 600;
        color: #2c3e50;
      }

      .message-bubble em,
      .message-bubble i {
        font-style: italic;
        color: #34495e;
      }

      .message-bubble code {
        background: rgba(0, 0, 0, 0.1);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .message-bubble pre {
        background: rgba(0, 0, 0, 0.1);
        padding: 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
        overflow-x: auto;
      }

      .message-bubble pre code {
        background: none;
        padding: 0;
      }

      .message-bubble ul,
      .message-bubble ol {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }

      .message-bubble li {
        margin: 0.25rem 0;
        line-height: 1.4;
      }

      .message-bubble blockquote {
        border-left: 3px solid #667eea;
        padding: 0.5rem 1rem;
        margin: 0.5rem 0;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 0 8px 8px 0;
      }

      .message-bubble a {
        color: #667eea;
        text-decoration: none;
      }

      .message-bubble a:hover {
        text-decoration: underline;
      }

      .message-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        min-width: 35px;
      }

      .message.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .message.bot .message-avatar {
        background: #e9ecef;
        color: #6c757d;
      }

      .chat-input {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
      }

      .input-container {
        position: relative;
        margin-bottom: 0.5rem;
        padding-bottom: 20px;
      }

      .chat-input-field {
        width: 100%;
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        padding-right: 60px;
        resize: none;
        min-height: 50px;
        max-height: 150px;
        font-family: inherit;
      }

      .chat-input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
      }

      .send-button {
        position: absolute;
        right: 10px;
        top: 33%;
        transform: translateY(-50%);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .send-button:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .mode-indicator {
        text-align: center;
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
      }

      .mode-indicator .current-mode {
        font-weight: 600;
        color: #667eea;
      }

      .typing-indicator {
        display: none;
        padding: 0.5rem 1rem;
        color: #6c757d;
        font-style: italic;
      }

      .stats-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.9rem;
      }

      .vocabulary-result {
        margin-top: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        background: white;
      }

      .vocabulary-result:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .vocabulary-content {
        padding: 1.5rem;
      }

      .word-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
      }

      .word-title {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin: 0 0 0.5rem 0;
        text-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
      }

      .phonetic {
        font-size: 1.1rem;
        color: #6c757d;
        font-style: italic;
        margin-bottom: 0.75rem;
        font-family: "Courier New", monospace;
      }

      .word-meta {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .pos-tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      }

      .difficulty-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .difficulty-beginner {
        background: #28a745;
      }

      .difficulty-intermediate {
        background: #ffc107;
        color: #212529;
      }

      .difficulty-advanced {
        background: #dc3545;
      }

      .similarity-badge {
        background: #e9ecef;
        color: #6c757d;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 0.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border: 1px solid #ced4da;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #667eea;
      }

      .meaning-section,
      .examples-section,
      .synonyms-section {
        margin-bottom: 1.5rem;
      }

      .meaning {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: 10px;
        font-weight: 500;
        color: #495057;
        border-left: 4px solid #667eea;
      }

      .examples-list {
        margin: 0;
        padding-left: 1.2rem;
      }

      .examples-list li {
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .synonyms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .synonym-tag {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        color: #495057;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid #ced4da;
      }

      .mnemonic-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 2px solid #fdcb6e;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .mnemonic {
        color: #856404;
        font-style: italic;
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .vocabulary-list {
        margin-top: 0.5rem;
      }

      .vocabulary-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .vocabulary-item h6 {
        margin: 0 0 0.5rem 0;
        color: #667eea;
        font-weight: 600;
      }

      .semantic-search-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .semantic-search-header h5 {
        margin: 0 0 0.5rem 0;
        font-weight: 600;
      }

      .semantic-search-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9rem;
      }

      /* Beautiful Vocabulary Card Styles */
      .beautiful-vocab-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border: 1px solid #e9ecef;
        border-radius: 16px;
        margin: 1rem 0;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
      }

      .beautiful-vocab-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
      }

      .beautiful-vocab-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(
          90deg,
          #667eea 0%,
          #764ba2 50%,
          #667eea 100%
        );
      }

      .vocab-card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1.5rem;
        text-align: center;
        border-bottom: 1px solid #dee2e6;
      }

      .word-display {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      }

      .word-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: #667eea;
        margin: 0;
        text-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
        letter-spacing: 1px;
      }

      .audio-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
      }

      .audio-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .audio-btn:active {
        transform: scale(0.95);
      }

      .audio-btn .spinning {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .card-meta {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .meta-tag {
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(0, 0, 0, 0.1);
      }

      .pos-tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .category-tag {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
      }

      .similarity-tag {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
      }

      .vocab-card-body {
        padding: 1.5rem;
      }

      .vocab-card-body > div:not(:last-child) {
        margin-bottom: 1.5rem;
      }

      .meaning-section,
      .examples-section,
      .synonyms-section,
      .mnemonic-section {
        display: flex;
        gap: 1rem;
        align-items: flex-start;
      }

      .section-icon {
        font-size: 1.5rem;
        min-width: 2rem;
        text-align: center;
      }

      .section-content {
        flex: 1;
      }

      .section-title {
        font-weight: 700;
        color: #495057;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .meaning-text {
        background: linear-gradient(135deg, #e8f4fd 0%, #d1ecf1 100%);
        padding: 1rem;
        border-radius: 12px;
        color: #495057;
        font-weight: 500;
        border-left: 4px solid #17a2b8;
        font-size: 1rem;
        line-height: 1.6;
      }

      .examples-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1rem;
        border-left: 4px solid #28a745;
      }

      .example-item {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
        align-items: flex-start;
      }

      .example-item:last-child {
        margin-bottom: 0;
      }

      .example-number {
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        flex-shrink: 0;
      }

      .example-text {
        color: #495057;
        line-height: 1.6;
        font-size: 0.95rem;
      }

      .synonyms-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .synonym-badge {
        background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        color: white;
        padding: 0.4rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(111, 66, 193, 0.3);
        transition: transform 0.2s ease;
      }

      .synonym-badge:hover {
        transform: translateY(-1px);
      }

      .mnemonic-text {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 2px solid #ffc107;
        border-radius: 12px;
        padding: 1rem;
        color: #856404;
        font-style: italic;
        line-height: 1.6;
        font-size: 0.95rem;
        position: relative;
      }

      .mnemonic-text::before {
        content: '"';
        font-size: 2rem;
        color: #ffc107;
        position: absolute;
        top: -0.5rem;
        left: 0.5rem;
        font-family: serif;
      }

      .mnemonic-text::after {
        content: '"';
        font-size: 2rem;
        color: #ffc107;
        position: absolute;
        bottom: -1rem;
        right: 0.5rem;
        font-family: serif;
      }

      @media (max-width: 768px) {
        .mode-selector {
          padding: 0.75rem;
          gap: 0.5rem;
        }

        .mode-btn {
          padding: 0.5rem 1rem;
          min-width: 120px;
          font-size: 0.9rem;
        }

        .message-bubble {
          max-width: 85%;
        }

        .chat-input-field {
          padding-right: 60px;
        }

        .send-button {
          width: 35px;
          height: 35px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="bi bi-journal-bookmark"></i> FlashCard
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/"> <i class="bi bi-cards"></i> Thẻ học </a>
          <a class="nav-link" href="/list">
            <i class="bi bi-list-ul"></i> Danh sách
          </a>
          <a class="nav-link active" href="/chat">
            <i class="bi bi-chat-dots"></i> Chat
          </a>
          <a class="nav-link" href="/search">
            <i class="bi bi-search"></i> Tìm kiếm
          </a>
        </div>
      </div>
    </nav>

    <div class="chat-container">
      <div class="chat-header">
        <h4><i class="bi bi-robot"></i> Vocabulary Assistant</h4>
        <p class="mb-0">
          Trợ lý học từ vựng thông minh - Chọn chế độ phù hợp
          <span class="stats-badge ms-2">
            <i class="bi bi-collection"></i> {{ total_words }} từ đã học
          </span>
        </p>
      </div>

      <div class="mode-selector">
        <button
          class="mode-btn active"
          onclick="switchMode('smart')"
          data-mode="smart"
        >
          <i class="bi bi-lightning-charge mode-icon"></i>
          <span>Thông minh</span>
        </button>
        <button class="mode-btn" onclick="switchMode('chat')" data-mode="chat">
          <i class="bi bi-chat-dots mode-icon"></i>
          <span>Trò chuyện</span>
        </button>
        <button class="mode-btn" onclick="switchMode('word')" data-mode="word">
          <i class="bi bi-plus-circle mode-icon"></i>
          <span>Thêm từ</span>
        </button>
        <button
          class="mode-btn"
          onclick="switchMode('analyze')"
          data-mode="analyze"
        >
          <i class="bi bi-file-text mode-icon"></i>
          <span>Phân tích văn bản</span>
        </button>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="message bot">
          <div class="message-avatar">
            <i class="bi bi-robot"></i>
          </div>
          <div class="message-bubble">
            Xin chào! 👋 Tôi là trợ lý học từ vựng của bạn.
            <br /><br />
            🎯 <strong>Chọn chế độ phù hợp:</strong>
            <br />
            ⚡ <strong>Thông minh:</strong> AI tự hiểu ý định - tìm kiếm, thêm
            từ, trò chuyện tự động
            <br />
            💬 <strong>Trò chuyện:</strong> Hỏi đáp về tiếng Anh, học tập
            <br />
            📚 <strong>Thêm từ:</strong> Nhập từ tiếng Anh để phân tích và lưu
            <br />
            📄 <strong>Phân tích văn bản:</strong> Dán văn bản để trích xuất từ
            vựng <br /><br />
            🌟 <strong>Khuyến nghị:</strong> Dùng chế độ
            <strong>"Thông minh"</strong> để có trải nghiệm tốt nhất!
          </div>
        </div>
      </div>

      <div class="typing-indicator" id="typing-indicator">
        <i class="bi bi-three-dots"></i> Đang xử lý...
      </div>

      <div class="chat-input">
        <div class="mode-indicator">
          Chế độ hiện tại:
          <span class="current-mode" id="current-mode">Trò chuyện</span>
        </div>
        <div class="input-container">
          <textarea
            class="chat-input-field"
            id="chat-input"
            placeholder="Nhập tin nhắn..."
            rows="1"
          ></textarea>
          <button
            class="send-button"
            onclick="sendMessage()"
            title="Gửi tin nhắn"
          >
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentMode = "smart";

      function createVocabularyHtml(data) {
        let html = '<div class="vocabulary-content">';

        // Word header
        html += '<div class="word-header">';
        html += `<h3 class="word-title">${data.word.toUpperCase()}</h3>`;

        if (data.phonetic) {
          html += `<div class="phonetic">/${data.phonetic}/</div>`;
        }

        html += '<div class="word-meta">';
        if (data.part_of_speech) {
          html += `<span class="pos-tag">${data.part_of_speech}</span>`;
        }
        if (data.difficulty_level) {
          const emoji =
            data.difficulty_level === "beginner"
              ? "🟢"
              : data.difficulty_level === "intermediate"
              ? "🟡"
              : "🔴";
          html += `<span class="difficulty-badge difficulty-${
            data.difficulty_level
          }">${emoji} ${
            data.difficulty_level.charAt(0).toUpperCase() +
            data.difficulty_level.slice(1)
          }</span>`;
        }
        // Add similarity score if available
        if (data.similarity_score) {
          const scoreEmoji =
            data.similarity_score >= 0.7
              ? "🎯"
              : data.similarity_score >= 0.5
              ? "📍"
              : "📌";
          html += `<span class="similarity-badge" title="Độ tương đồng: ${
            data.similarity_score
          }">${scoreEmoji} ${(data.similarity_score * 100).toFixed(0)}%</span>`;
        }
        html += "</div></div>";

        // Meaning section
        if (data.vietnamese_meaning) {
          html += '<div class="meaning-section">';
          html += '<div class="section-title">🇻🇳 Nghĩa</div>';
          html += `<div class="meaning">${data.vietnamese_meaning}</div>`;
          html += "</div>";
        }

        // Examples section
        if (data.example_sentences && data.example_sentences.length > 0) {
          html += '<div class="examples-section">';
          html += '<div class="section-title">📝 Ví dụ</div>';
          html += '<ol class="examples-list">';
          data.example_sentences.forEach((sentence) => {
            html += `<li>${sentence}</li>`;
          });
          html += "</ol></div>";
        }

        // Synonyms section
        if (data.synonyms && data.synonyms.length > 0) {
          html += '<div class="synonyms-section">';
          html += '<div class="section-title">🔄 Từ đồng nghĩa</div>';
          html += '<div class="synonyms">';
          data.synonyms.forEach((synonym) => {
            html += `<span class="synonym-tag">${synonym}</span>`;
          });
          html += "</div></div>";
        }

        // Mnemonic section
        if (data.mnemonic_tip) {
          html += '<div class="mnemonic-section">';
          html += '<div class="section-title">💡 Mẹo học dễ nhớ</div>';
          html += `<div class="mnemonic">${data.mnemonic_tip}</div>`;
          html += "</div>";
        }

        html += "</div>";
        return html;
      }

      function createBeautifulVocabularyCard(data, cardIndex = 0) {
        const cardId = `vocab-card-${Date.now()}-${cardIndex}`;

        let html = `<div class="beautiful-vocab-card" id="${cardId}">`;

        // Card Header with Word and Audio
        html += '<div class="vocab-card-header">';
        html += `<div class="word-display">
          <h3 class="word-title">${data.word.toUpperCase()}</h3>
          <button class="audio-btn" onclick="playWordAudio('${
            data.word
          }', '${cardId}')" title="Nghe phát âm">
            <i class="bi bi-volume-up"></i>
          </button>
        </div>`;

        if (data.phonetic) {
          html += `<div class="phonetic">/${data.phonetic}/</div>`;
        }

        // Meta information
        html += '<div class="card-meta">';
        if (data.part_of_speech) {
          html += `<span class="meta-tag pos-tag">${data.part_of_speech}</span>`;
        }
        if (data.category) {
          html += `<span class="meta-tag category-tag">${data.category}</span>`;
        }
        if (data.difficulty_level) {
          const difficultyEmoji = {
            beginner: "🟢",
            intermediate: "🟡",
            advanced: "🔴",
          };
          html += `<span class="meta-tag difficulty-tag difficulty-${
            data.difficulty_level
          }">
            ${difficultyEmoji[data.difficulty_level] || "⚪"} ${
            data.difficulty_level
          }
          </span>`;
        }
        if (data.similarity_score > 0) {
          const percentage = Math.round(data.similarity_score * 100);
          html += `<span class="meta-tag similarity-tag" title="Độ phù hợp: ${percentage}%">
            🎯 ${percentage}%
          </span>`;
        }
        html += "</div></div>"; // Close header

        // Card Body
        html += '<div class="vocab-card-body">';

        // Vietnamese Meaning
        if (data.vietnamese_meaning) {
          html += `<div class="meaning-section">
            <div class="section-icon">🇻🇳</div>
            <div class="section-content">
              <div class="section-title">Nghĩa tiếng Việt</div>
              <div class="meaning-text">${data.vietnamese_meaning}</div>
            </div>
          </div>`;
        }

        // Example Sentences
        if (data.example_sentences && data.example_sentences.length > 0) {
          html += `<div class="examples-section">
            <div class="section-icon">📝</div>
            <div class="section-content">
              <div class="section-title">Câu ví dụ</div>
              <div class="examples-container">`;

          data.example_sentences.forEach((sentence, index) => {
            html += `<div class="example-item">
              <span class="example-number">${index + 1}</span>
              <span class="example-text">${sentence}</span>
            </div>`;
          });

          html += "</div></div></div>";
        }

        // Synonyms
        if (data.synonyms && data.synonyms.length > 0) {
          html += `<div class="synonyms-section">
            <div class="section-icon">🔄</div>
            <div class="section-content">
              <div class="section-title">Từ đồng nghĩa</div>
              <div class="synonyms-container">`;

          data.synonyms.forEach((synonym) => {
            html += `<span class="synonym-badge">${synonym}</span>`;
          });

          html += "</div></div></div>";
        }

        // Mnemonic Tip
        if (data.mnemonic_tip) {
          html += `<div class="mnemonic-section">
            <div class="section-icon">💡</div>
            <div class="section-content">
              <div class="section-title">Mẹo ghi nhớ</div>
              <div class="mnemonic-text">${data.mnemonic_tip}</div>
            </div>
          </div>`;
        }

        html += "</div></div>"; // Close body and card

        return html;
      }

      // Audio playback function
      async function playWordAudio(word, cardId) {
        const audioBtn = document.querySelector(`#${cardId} .audio-btn`);
        const originalContent = audioBtn.innerHTML;

        try {
          audioBtn.innerHTML = '<i class="bi bi-hourglass-split spinning"></i>';
          audioBtn.disabled = true;

          // Try to get existing audio or generate new one
          const response = await fetch(
            `/api/generate-audio/${encodeURIComponent(word)}`
          );
          const data = await response.json();

          if (data.success && data.audio_path) {
            const audio = new Audio(data.audio_path);

            audio.onloadstart = () => {
              audioBtn.innerHTML =
                '<i class="bi bi-hourglass-split spinning"></i>';
            };

            audio.oncanplay = () => {
              audioBtn.innerHTML = '<i class="bi bi-play-fill"></i>';
            };

            audio.onplay = () => {
              audioBtn.innerHTML = '<i class="bi bi-pause-fill"></i>';
            };

            audio.onended = () => {
              audioBtn.innerHTML = originalContent;
              audioBtn.disabled = false;
            };

            audio.onerror = () => {
              audioBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
              setTimeout(() => {
                audioBtn.innerHTML = originalContent;
                audioBtn.disabled = false;
              }, 2000);
            };

            await audio.play();
          } else {
            throw new Error(data.message || "Cannot generate audio");
          }
        } catch (error) {
          console.error("Audio playback error:", error);
          audioBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
          setTimeout(() => {
            audioBtn.innerHTML = originalContent;
            audioBtn.disabled = false;
          }, 2000);
        }
      }

      function addMessage(sender, content, isHtml = false, isMarkdown = false) {
        const messagesContainer = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.innerHTML =
          sender === "user"
            ? '<i class="bi bi-person"></i>'
            : '<i class="bi bi-robot"></i>';

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";

        if (isHtml) {
          bubble.innerHTML = content;
        } else if (isMarkdown) {
          // Parse markdown and render as HTML
          bubble.innerHTML = marked.parse(content);
        } else {
          bubble.textContent = content;
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTyping() {
        document.getElementById("typing-indicator").style.display = "block";
        const messagesContainer = document.getElementById("chat-messages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideTyping() {
        document.getElementById("typing-indicator").style.display = "none";
      }

      function switchMode(mode) {
        // Update active button
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add("active");

        // Update current mode
        currentMode = mode;

        // Update mode indicator
        const modeNames = {
          smart: "Thông minh",
          chat: "Trò chuyện",
          word: "Thêm từ",
          analyze: "Phân tích văn bản",
        };
        document.getElementById("current-mode").textContent = modeNames[mode];

        // Update placeholder
        const placeholders = {
          smart: 'Nhập câu hỏi hoặc từ vựng...',
          chat: "Nhập tin nhắn...",
          word: "Nhập từ tiếng Anh...",
          analyze: "Dán văn bản tiếng Anh...",
        };
        document.getElementById("chat-input").placeholder = placeholders[mode];

        // Clear input
        document.getElementById("chat-input").value = "";
        document.getElementById("chat-input").style.height = "auto";

        // Focus input
        document.getElementById("chat-input").focus();

        // Add mode switch message
        addMessage(
          "bot",
          `🔄 **Đã chuyển sang chế độ:** ${modeNames[mode]}`,
          false,
          true
        );
      }

      function sendMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();

        if (!message) {
          addMessage(
            "bot",
            "❌ **Vui lòng nhập nội dung trước khi gửi!**",
            false,
            true
          );
          input.focus();
          return;
        }

        // Add user message
        addMessage("user", message);

        // Clear input
        input.value = "";
        input.style.height = "auto";

        // Show typing indicator
        showTyping();

        // Send based on current mode
        switch (currentMode) {
          case "smart":
            sendToSmartAPI(message);
            break;
          case "chat":
            sendToChatAPI(message);
            break;
          case "word":
            sendToWordAPI(message);
            break;
          case "analyze":
            sendToAnalyzeAPI(message);
            break;
          default:
            sendToSmartAPI(message);
        }
      }

      async function sendToSmartAPI(message) {
        try {
          // Use the new intelligent chat API
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            // Display vocabulary cards if available (priority display)
            if (data.vocabulary_cards && data.vocabulary_cards.length > 0) {
              // Show brief intro message instead of agent's verbose response
              addMessage(
                "bot",
                `🔍 Tìm thấy ${data.vocabulary_cards.length} từ vựng phù hợp:`
              );

              setTimeout(() => {
                data.vocabulary_cards.forEach((cardData, index) => {
                  const cardHtml = createBeautifulVocabularyCard(
                    cardData,
                    index
                  );
                  addMessage("bot", cardHtml, true);
                });

                // Add a helpful follow-up message
                setTimeout(() => {
                  addMessage(
                    "bot",
                    "💡 **Mẹo:** Nhấn vào biểu tượng 🔊 để nghe phát âm. Bạn có câu hỏi gì khác không?",
                    false,
                    true
                  );
                }, 500);
              }, 300);
            }
            // Only show agent response if no vocabulary cards are available
            else {
              addMessage("bot", data.message, false, true); // Enable markdown rendering

              // Handle legacy tool results (fallback)
              if (data.tool_results) {
                setTimeout(() => {
                  if (data.tool_results.vocabulary_results) {
                    data.tool_results.vocabulary_results.forEach((vocab) => {
                      if (vocab.structured) {
                        const resultHtml = createVocabularyHtml(
                          vocab.structured
                        );
                        addMessage(
                          "bot",
                          `<div class="vocabulary-result">${resultHtml}</div>`,
                          true
                        );
                      }
                    });
                  }

                  if (data.tool_results.search_results) {
                    data.tool_results.search_results.forEach((vocab) => {
                      const resultHtml = createVocabularyHtml(vocab);
                      addMessage(
                        "bot",
                        `<div class="vocabulary-result">${resultHtml}</div>`,
                        true
                      );
                    });
                  }
                }, 300);
              }
            }
          } else {
            addMessage(
              "bot",
              data.message || "❌ **Đã xảy ra lỗi.** Vui lòng thử lại!",
              false,
              true
            );
          }
        } catch (error) {
          hideTyping();
          console.error("Smart API Error:", error);
          addMessage(
            "bot",
            "❌ **Đã xảy ra lỗi kết nối.** Vui lòng thử lại!",
            false,
            true
          );
        }
      }

      async function sendToChatAPI(message) {
        try {
          // For general chat, use the semantic search API
          const response = await fetch("/api/semantic-search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            // Check if this is a semantic search result
            if (
              data.type === "semantic_search" &&
              data.structured_results &&
              data.structured_results.length > 0
            ) {
              // Display a clean header message
              addMessage("bot", data.message, false, true);

              // Then display each result as a structured vocabulary card
              setTimeout(() => {
                data.structured_results.forEach((vocab, index) => {
                  if (vocab.structured) {
                    const resultHtml = createVocabularyHtml(vocab.structured);
                    addMessage(
                      "bot",
                      `<div class="vocabulary-result">${resultHtml}</div>`,
                      true
                    );
                  }
                });
              }, 300);
            } else {
              // Regular chat response
              addMessage("bot", data.message, false, true);
            }
          } else {
            addMessage("bot", data.message, false, true);
          }
        } catch (error) {
          hideTyping();
          addMessage(
            "bot",
            "❌ **Đã xảy ra lỗi kết nối.** Vui lòng thử lại!",
            false,
            true
          );
        }
      }

      async function sendToWordAPI(message) {
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              type: "word",
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            // Show the extracted word if it's different from the original input
            if (data.extracted_word && data.extracted_word !== message.trim()) {
              addMessage(
                "bot",
                `🔍 Tôi đã hiểu bạn muốn thêm từ: **${data.extracted_word}**`,
                false,
                true
              );
            }

            addMessage("bot", data.message, false, true);

            if (data.result) {
              if (data.structured_data) {
                const resultHtml = createVocabularyHtml(data.structured_data);
                addMessage(
                  "bot",
                  `<div class="vocabulary-result">${resultHtml}</div>`,
                  true
                );
              } else {
                const resultHtml = `<div class="vocabulary-result">${data.result}</div>`;
                addMessage("bot", resultHtml, true);
              }
            }

            // Add follow-up message
            setTimeout(() => {
              addMessage(
                "bot",
                "✨ **Từ vựng đã được lưu!** Bạn có muốn thêm từ khác không?",
                false,
                true
              );
            }, 1000);
          } else {
            addMessage("bot", data.message, false, true);
          }
        } catch (error) {
          hideTyping();
          addMessage(
            "bot",
            "❌ **Đã xảy ra lỗi kết nối.** Vui lòng thử lại!",
            false,
            true
          );
        }
      }

      async function sendToAnalyzeAPI(message) {
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              type: "text",
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            addMessage("bot", data.message, false, true);

            if (data.results) {
              let listHtml = '<div class="vocabulary-list">';
              data.results.forEach((vocab) => {
                if (vocab.structured) {
                  listHtml += `
                  <div class="vocabulary-item">
                    <h6>${vocab.word}</h6>
                    <div class="vocabulary-content">${createVocabularyHtml(
                      vocab.structured
                    )}</div>
                  </div>
                `;
                } else {
                  listHtml += `
                  <div class="vocabulary-item">
                    <h6>${vocab.word}</h6>
                    <div style="font-size: 0.9rem; white-space: pre-wrap;">${vocab.formatted}</div>
                  </div>
                `;
                }
              });
              listHtml += "</div>";
              addMessage("bot", listHtml, true);
            }

            // Add follow-up message
            setTimeout(() => {
              addMessage(
                "bot",
                "✨ **Đã trích xuất và lưu từ vựng từ văn bản!** Bạn có muốn phân tích văn bản khác không?",
                false,
                true
              );
            }, 1000);
          } else {
            addMessage("bot", data.message, false, true);
          }
        } catch (error) {
          hideTyping();
          addMessage(
            "bot",
            "❌ **Đã xảy ra lỗi kết nối.** Vui lòng thử lại!",
            false,
            true
          );
        }
      }

      // Auto-resize textarea
      document
        .getElementById("chat-input")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 150) + "px";
        });

      // Enter key handling
      document
        .getElementById("chat-input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });

      // Focus input on page load
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("chat-input").focus();
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          // Clear input
          document.getElementById("chat-input").value = "";
          document.getElementById("chat-input").style.height = "auto";
          document.getElementById("chat-input").focus();
        }
      });
    </script>
  </body>
</html>
