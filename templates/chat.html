<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vocabulary Chat Assistant</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />

    <style>
      body {
        background-color: #f4f6f8;
        padding: 0;
        margin: 0;
        height: 100vh;
        overflow: hidden;
      }

      .navbar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
      }

      .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
      }

      .chat-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        margin-top: 60px;
        background: white;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding-bottom: 20px;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        text-align: center;
        border-radius: 0;
      }

      .mode-selector {
        background: #f8f9fa;
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .mode-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        background: white;
        color: #6c757d;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 140px;
        justify-content: center;
      }

      .mode-btn:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .mode-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .mode-btn .mode-icon {
        font-size: 1.2rem;
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        max-height: calc(100vh - 280px);
      }

      .message {
        margin-bottom: 1rem;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
      }

      .message.user .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
      }

      .message.bot .message-bubble {
        background: #f1f3f5;
        color: #333;
        border: 1px solid #e9ecef;
      }

      .message-avatar {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        min-width: 35px;
      }

      .message.user .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .message.bot .message-avatar {
        background: #e9ecef;
        color: #6c757d;
      }

      .chat-input {
        padding: 1rem;
        background: white;
        border-top: 1px solid #dee2e6;
      }

      .input-container {
        position: relative;
        margin-bottom: 0.5rem;
        padding-bottom: 20px;
      }

      .chat-input-field {
        width: 100%;
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        padding-right: 60px;
        resize: none;
        min-height: 50px;
        max-height: 150px;
        font-family: inherit;
      }

      .chat-input-field:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        outline: none;
      }

      .send-button {
        position: absolute;
        right: 10px;
        top: 33%;
        transform: translateY(-50%);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .send-button:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .mode-indicator {
        text-align: center;
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
      }

      .mode-indicator .current-mode {
        font-weight: 600;
        color: #667eea;
      }

      .typing-indicator {
        display: none;
        padding: 0.5rem 1rem;
        color: #6c757d;
        font-style: italic;
      }

      .stats-badge {
        background: rgba(255, 255, 255, 0.2);
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.9rem;
      }

      .vocabulary-result {
        margin-top: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        background: white;
      }

      .vocabulary-result:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }

      .vocabulary-content {
        padding: 1.5rem;
      }

      .word-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
      }

      .word-title {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
        margin: 0 0 0.5rem 0;
        text-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);
      }

      .phonetic {
        font-size: 1.1rem;
        color: #6c757d;
        font-style: italic;
        margin-bottom: 0.75rem;
        font-family: "Courier New", monospace;
      }

      .word-meta {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .pos-tag {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
      }

      .difficulty-badge {
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .difficulty-beginner {
        background: #28a745;
      }

      .difficulty-intermediate {
        background: #ffc107;
        color: #212529;
      }

      .difficulty-advanced {
        background: #dc3545;
      }

      .similarity-badge {
        background: #e9ecef;
        color: #6c757d;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 0.5rem;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        border: 1px solid #ced4da;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #667eea;
      }

      .meaning-section,
      .examples-section,
      .synonyms-section {
        margin-bottom: 1.5rem;
      }

      .meaning {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 1rem;
        border-radius: 10px;
        font-weight: 500;
        color: #495057;
        border-left: 4px solid #667eea;
      }

      .examples-list {
        margin: 0;
        padding-left: 1.2rem;
      }

      .examples-list li {
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .synonyms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .synonym-tag {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        color: #495057;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid #ced4da;
      }

      .mnemonic-section {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border: 2px solid #fdcb6e;
        border-radius: 10px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .mnemonic {
        color: #856404;
        font-style: italic;
        margin: 0;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .vocabulary-list {
        margin-top: 0.5rem;
      }

      .vocabulary-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
      }

      .vocabulary-item h6 {
        margin: 0 0 0.5rem 0;
        color: #667eea;
        font-weight: 600;
      }

      .semantic-search-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        text-align: center;
      }

      .semantic-search-header h5 {
        margin: 0 0 0.5rem 0;
        font-weight: 600;
      }

      .semantic-search-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .mode-selector {
          padding: 0.75rem;
          gap: 0.5rem;
        }

        .mode-btn {
          padding: 0.5rem 1rem;
          min-width: 120px;
          font-size: 0.9rem;
        }

        .message-bubble {
          max-width: 85%;
        }

        .chat-input-field {
          padding-right: 60px;
        }

        .send-button {
          width: 35px;
          height: 35px;
          font-size: 0.9rem;
        }
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="bi bi-journal-bookmark"></i> FlashCard
        </a>
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/"> <i class="bi bi-cards"></i> Th·∫ª h·ªçc </a>
          <a class="nav-link" href="/list">
            <i class="bi bi-list-ul"></i> Danh s√°ch
          </a>
          <a class="nav-link active" href="/chat">
            <i class="bi bi-chat-dots"></i> Chat
          </a>
          <a class="nav-link" href="/search">
            <i class="bi bi-search"></i> T√¨m ki·∫øm
          </a>
        </div>
      </div>
    </nav>

    <div class="chat-container">
      <div class="chat-header">
        <h4><i class="bi bi-robot"></i> Vocabulary Assistant</h4>
        <p class="mb-0">
          Tr·ª£ l√Ω h·ªçc t·ª´ v·ª±ng th√¥ng minh - Ch·ªçn ch·∫ø ƒë·ªô ph√π h·ª£p
          <span class="stats-badge ms-2">
            <i class="bi bi-collection"></i> {{ total_words }} t·ª´ ƒë√£ h·ªçc
          </span>
        </p>
      </div>

      <div class="mode-selector">
        <button
          class="mode-btn active"
          onclick="switchMode('chat')"
          data-mode="chat"
        >
          <i class="bi bi-chat-dots mode-icon"></i>
          <span>Tr√≤ chuy·ªán</span>
        </button>
        <button class="mode-btn" onclick="switchMode('word')" data-mode="word">
          <i class="bi bi-plus-circle mode-icon"></i>
          <span>Th√™m t·ª´</span>
        </button>
        <button
          class="mode-btn"
          onclick="switchMode('analyze')"
          data-mode="analyze"
        >
          <i class="bi bi-file-text mode-icon"></i>
          <span>Ph√¢n t√≠ch vƒÉn b·∫£n</span>
        </button>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="message bot">
          <div class="message-avatar">
            <i class="bi bi-robot"></i>
          </div>
          <div class="message-bubble">
            Xin ch√†o! üëã T√¥i l√† tr·ª£ l√Ω h·ªçc t·ª´ v·ª±ng c·ªßa b·∫°n.
            <br /><br />
            üéØ <strong>Ch·ªçn ch·∫ø ƒë·ªô ph√π h·ª£p:</strong>
            <br />
            üí¨ <strong>Tr√≤ chuy·ªán:</strong> H·ªèi ƒë√°p v·ªÅ ti·∫øng Anh, h·ªçc t·∫≠p
            <br />
            üìö <strong>Th√™m t·ª´:</strong> Nh·∫≠p t·ª´ ti·∫øng Anh ƒë·ªÉ ph√¢n t√≠ch v√† l∆∞u
            <br />
            üìÑ <strong>Ph√¢n t√≠ch vƒÉn b·∫£n:</strong> D√°n vƒÉn b·∫£n ƒë·ªÉ tr√≠ch xu·∫•t t·ª´
            v·ª±ng <br /><br />
            H√£y ch·ªçn ch·∫ø ƒë·ªô v√† b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng!
          </div>
        </div>
      </div>

      <div class="typing-indicator" id="typing-indicator">
        <i class="bi bi-three-dots"></i> ƒêang x·ª≠ l√Ω...
      </div>

      <div class="chat-input">
        <div class="mode-indicator">
          Ch·∫ø ƒë·ªô hi·ªán t·∫°i:
          <span class="current-mode" id="current-mode">Tr√≤ chuy·ªán</span>
        </div>
        <div class="input-container">
          <textarea
            class="chat-input-field"
            id="chat-input"
            placeholder="Nh·∫≠p tin nh·∫Øn..."
            rows="1"
          ></textarea>
          <button
            class="send-button"
            onclick="sendMessage()"
            title="G·ª≠i tin nh·∫Øn"
          >
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentMode = "chat";

      function createVocabularyHtml(data) {
        let html = '<div class="vocabulary-content">';

        // Word header
        html += '<div class="word-header">';
        html += `<h3 class="word-title">${data.word.toUpperCase()}</h3>`;

        if (data.phonetic) {
          html += `<div class="phonetic">/${data.phonetic}/</div>`;
        }

        html += '<div class="word-meta">';
        if (data.part_of_speech) {
          html += `<span class="pos-tag">${data.part_of_speech}</span>`;
        }
        if (data.difficulty_level) {
          const emoji =
            data.difficulty_level === "beginner"
              ? "üü¢"
              : data.difficulty_level === "intermediate"
              ? "üü°"
              : "üî¥";
          html += `<span class="difficulty-badge difficulty-${
            data.difficulty_level
          }">${emoji} ${
            data.difficulty_level.charAt(0).toUpperCase() +
            data.difficulty_level.slice(1)
          }</span>`;
        }
        // Add similarity score if available
        if (data.similarity_score) {
          const scoreEmoji =
            data.similarity_score >= 0.7
              ? "üéØ"
              : data.similarity_score >= 0.5
              ? "üìç"
              : "üìå";
          html += `<span class="similarity-badge" title="ƒê·ªô t∆∞∆°ng ƒë·ªìng: ${
            data.similarity_score
          }">${scoreEmoji} ${(data.similarity_score * 100).toFixed(0)}%</span>`;
        }
        html += "</div></div>";

        // Meaning section
        if (data.vietnamese_meaning) {
          html += '<div class="meaning-section">';
          html += '<div class="section-title">üáªüá≥ Nghƒ©a</div>';
          html += `<div class="meaning">${data.vietnamese_meaning}</div>`;
          html += "</div>";
        }

        // Examples section
        if (data.example_sentences && data.example_sentences.length > 0) {
          html += '<div class="examples-section">';
          html += '<div class="section-title">üìù V√≠ d·ª•</div>';
          html += '<ol class="examples-list">';
          data.example_sentences.forEach((sentence) => {
            html += `<li>${sentence}</li>`;
          });
          html += "</ol></div>";
        }

        // Synonyms section
        if (data.synonyms && data.synonyms.length > 0) {
          html += '<div class="synonyms-section">';
          html += '<div class="section-title">üîÑ T·ª´ ƒë·ªìng nghƒ©a</div>';
          html += '<div class="synonyms">';
          data.synonyms.forEach((synonym) => {
            html += `<span class="synonym-tag">${synonym}</span>`;
          });
          html += "</div></div>";
        }

        // Mnemonic section
        if (data.mnemonic_tip) {
          html += '<div class="mnemonic-section">';
          html += '<div class="section-title">üí° M·∫πo h·ªçc d·ªÖ nh·ªõ</div>';
          html += `<div class="mnemonic">${data.mnemonic_tip}</div>`;
          html += "</div>";
        }

        html += "</div>";
        return html;
      }

      function addMessage(sender, content, isHtml = false) {
        const messagesContainer = document.getElementById("chat-messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.innerHTML =
          sender === "user"
            ? '<i class="bi bi-person"></i>'
            : '<i class="bi bi-robot"></i>';

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";

        if (isHtml) {
          bubble.innerHTML = content;
        } else {
          bubble.textContent = content;
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);

        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTyping() {
        document.getElementById("typing-indicator").style.display = "block";
        const messagesContainer = document.getElementById("chat-messages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideTyping() {
        document.getElementById("typing-indicator").style.display = "none";
      }

      function switchMode(mode) {
        // Update active button
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelector(`[data-mode="${mode}"]`).classList.add("active");

        // Update current mode
        currentMode = mode;

        // Update mode indicator
        const modeNames = {
          chat: "Tr√≤ chuy·ªán",
          word: "Th√™m t·ª´",
          analyze: "Ph√¢n t√≠ch vƒÉn b·∫£n",
        };
        document.getElementById("current-mode").textContent = modeNames[mode];

        // Update placeholder
        const placeholders = {
          chat: "Nh·∫≠p tin nh·∫Øn...",
          word: "Nh·∫≠p t·ª´ ti·∫øng Anh...",
          analyze: "D√°n vƒÉn b·∫£n ti·∫øng Anh...",
        };
        document.getElementById("chat-input").placeholder = placeholders[mode];

        // Clear input
        document.getElementById("chat-input").value = "";
        document.getElementById("chat-input").style.height = "auto";

        // Focus input
        document.getElementById("chat-input").focus();

        // Add mode switch message
        addMessage("bot", `üîÑ ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô: ${modeNames[mode]}`);
      }

      function sendMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();

        if (!message) {
          addMessage("bot", "‚ùå Vui l√≤ng nh·∫≠p n·ªôi dung tr∆∞·ªõc khi g·ª≠i!");
          input.focus();
          return;
        }

        // Add user message
        addMessage("user", message);

        // Clear input
        input.value = "";
        input.style.height = "auto";

        // Show typing indicator
        showTyping();

        // Send based on current mode
        switch (currentMode) {
          case "chat":
            sendToChatAPI(message);
            break;
          case "word":
            sendToWordAPI(message);
            break;
          case "analyze":
            sendToAnalyzeAPI(message);
            break;
          default:
            sendToChatAPI(message);
        }
      }

      async function sendToChatAPI(message) {
        try {
          // For general chat, use the semantic search API
          const response = await fetch("/api/semantic-search", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            // Check if this is a semantic search result
            if (
              data.type === "semantic_search" &&
              data.structured_results &&
              data.structured_results.length > 0
            ) {
              // Display a clean header message
              addMessage("bot", data.message);

              // Then display each result as a structured vocabulary card
              setTimeout(() => {
                data.structured_results.forEach((vocab, index) => {
                  if (vocab.structured) {
                    const resultHtml = createVocabularyHtml(vocab.structured);
                    addMessage(
                      "bot",
                      `<div class="vocabulary-result">${resultHtml}</div>`,
                      true
                    );
                  }
                });
              }, 300);
            } else {
              // Regular chat response
              addMessage("bot", data.message);
            }
          } else {
            addMessage("bot", data.message);
          }
        } catch (error) {
          hideTyping();
          addMessage("bot", "‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!");
        }
      }

      async function sendToWordAPI(message) {
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              type: "word",
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            // Show the extracted word if it's different from the original input
            if (data.extracted_word && data.extracted_word !== message.trim()) {
              addMessage(
                "bot",
                `üîç T√¥i ƒë√£ hi·ªÉu b·∫°n mu·ªën th√™m t·ª´: <strong>${data.extracted_word}</strong>`
              );
            }

            addMessage("bot", data.message);

            if (data.result) {
              if (data.structured_data) {
                const resultHtml = createVocabularyHtml(data.structured_data);
                addMessage(
                  "bot",
                  `<div class="vocabulary-result">${resultHtml}</div>`,
                  true
                );
              } else {
                const resultHtml = `<div class="vocabulary-result">${data.result}</div>`;
                addMessage("bot", resultHtml, true);
              }
            }

            // Add follow-up message
            setTimeout(() => {
              addMessage(
                "bot",
                "‚ú® T·ª´ v·ª±ng ƒë√£ ƒë∆∞·ª£c l∆∞u! B·∫°n c√≥ mu·ªën th√™m t·ª´ kh√°c kh√¥ng?"
              );
            }, 1000);
          } else {
            addMessage("bot", data.message);
          }
        } catch (error) {
          hideTyping();
          addMessage("bot", "‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!");
        }
      }

      async function sendToAnalyzeAPI(message) {
        try {
          const response = await fetch("/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: message,
              type: "text",
            }),
          });

          const data = await response.json();
          hideTyping();

          if (data.success) {
            addMessage("bot", data.message);

            if (data.results) {
              let listHtml = '<div class="vocabulary-list">';
              data.results.forEach((vocab) => {
                if (vocab.structured) {
                  listHtml += `
                  <div class="vocabulary-item">
                    <h6>${vocab.word}</h6>
                    <div class="vocabulary-content">${createVocabularyHtml(
                      vocab.structured
                    )}</div>
                  </div>
                `;
                } else {
                  listHtml += `
                  <div class="vocabulary-item">
                    <h6>${vocab.word}</h6>
                    <div style="font-size: 0.9rem; white-space: pre-wrap;">${vocab.formatted}</div>
                  </div>
                `;
                }
              });
              listHtml += "</div>";
              addMessage("bot", listHtml, true);
            }

            // Add follow-up message
            setTimeout(() => {
              addMessage(
                "bot",
                "‚ú® ƒê√£ tr√≠ch xu·∫•t v√† l∆∞u t·ª´ v·ª±ng t·ª´ vƒÉn b·∫£n! B·∫°n c√≥ mu·ªën ph√¢n t√≠ch vƒÉn b·∫£n kh√°c kh√¥ng?"
              );
            }, 1000);
          } else {
            addMessage("bot", data.message);
          }
        } catch (error) {
          hideTyping();
          addMessage("bot", "‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i!");
        }
      }

      // Auto-resize textarea
      document
        .getElementById("chat-input")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 150) + "px";
        });

      // Enter key handling
      document
        .getElementById("chat-input")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });

      // Focus input on page load
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("chat-input").focus();
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          // Clear input
          document.getElementById("chat-input").value = "";
          document.getElementById("chat-input").style.height = "auto";
          document.getElementById("chat-input").focus();
        }
      });
    </script>
  </body>
</html>
